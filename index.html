<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth0 Sign-In Example with API Calls</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Auth0 SPA SDK -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Auth0 Sign-In Example with API Calls</h1>
        <button id="loginButton" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Log In</button>
        <button id="logoutButton" class="btn btn-danger" style="display:none;"><i class="fas fa-sign-out-alt"></i> Log Out</button>
        
        <div id="userInfo" class="mt-4" style="display:none;">
            <h2>User Information</h2>
            <pre id="userInfoContent" class="bg-light p-3 rounded"></pre>
        </div>
        
        <div id="tokenInfo" class="mt-4" style="display:none;">
            <h2>Token Information</h2>
            <pre id="tokenInfoContent" class="bg-light p-3 rounded"></pre>
        </div>
        
        <div id="accessTokenInfo" class="mt-4" style="display:none;">
            <h2>Access Token</h2>
            <pre id="accessTokenContent" class="bg-light p-3 rounded"></pre>
        </div>
        
        <div id="apiCalls" class="mt-4" style="display:none;">
            <h2>API Callsss</h2>
            <button id="callRoot" class="btn btn-secondary"><i class="fas fa-home"></i> Call Root</button>
            <button id="callProtected" class="btn btn-info"><i class="fas fa-lock"></i> Call Protected</button>
            <button id="callAdmin" class="btn btn-warning"><i class="fas fa-user-shield"></i> Call Admin</button>
            <button id="callUserInfo" class="btn btn-success"><i class="fas fa-user"></i> Call User Info</button>
            <h3 class="mt-3">API Response:</h3>
            <pre id="apiResponse" class="bg-light p-3 rounded"></pre>
        </div>

    <div id="apiKeyManagement" class="mt-4" style="display:none;">
        <h2>API Key Management</h2>
        <button id="createApiKey" class="btn btn-success"><i class="fas fa-key"></i> Create API Key</button>
        <button id="listApiKeys" class="btn btn-info"><i class="fas fa-list"></i> List API Keys</button>
        <div id="apiKeyList" class="mt-3"></div>
    </div>

    <div id="apiKeyTest" class="mt-4" style="display:none;">
        <h2>Test API Key</h2>
        <input type="text" id="apiKeyInput" placeholder="Enter API Key" class="form-control mb-2">
        <button onclick="testApiKey(document.getElementById('apiKeyInput').value)" class="btn btn-primary">Test API Key</button>
    </div>
</div>

<script>
    let auth0Client;
    const apiBaseUrl = 'http://127.0.0.1:8000';
    let isUpdatingUI = false;

    window.onload = async () => {
        try {
            auth0Client = await auth0.createAuth0Client({
                domain: 'dev-mazc2h57lknel3yr.uk.auth0.com',
                clientId: 'ICvvsiC19v8WtUSQI910bSNQNjnWwKMF',
                authorizationParams: {
                    redirect_uri: window.location.origin,
                    audience: 'sspm',
                    scope: 'openid profile email'
                },
                cacheLocation: 'localstorage'  // Use localStorage for token storage
            });

            if (location.search.includes("code=") && location.search.includes("state=")) {
                await auth0Client.handleRedirectCallback();
                window.history.replaceState({}, document.title, "/");
            }

            await updateUI();

            document.getElementById('loginButton').onclick = login;
            document.getElementById('logoutButton').onclick = logout;
            document.getElementById('callRoot').onclick = () => callApi('/');
            document.getElementById('callProtected').onclick = () => callApi('/protected');
            document.getElementById('callAdmin').onclick = () => callApi('/admin');
            document.getElementById('callUserInfo').onclick = () => callApi('/user_info');
            document.getElementById('createApiKey').onclick = createApiKey;
            document.getElementById('listApiKeys').onclick = listApiKeys;
        } catch (error) {
            console.error("Error initializing Auth0:", error);
            showError("Failed to initialize authentication. Please try again later.");
        }
    };

    async function updateUI() {
        if (isUpdatingUI) return;
        isUpdatingUI = true;
        try {
            const isAuthenticated = await auth0Client.isAuthenticated();
            document.getElementById('loginButton').style.display = isAuthenticated ? 'none' : 'inline-block';
            document.getElementById('logoutButton').style.display = isAuthenticated ? 'inline-block' : 'none';
            document.getElementById('userInfo').style.display = isAuthenticated ? 'block' : 'none';
            document.getElementById('tokenInfo').style.display = isAuthenticated ? 'block' : 'none';
            document.getElementById('accessTokenInfo').style.display = isAuthenticated ? 'block' : 'none';
            document.getElementById('apiCalls').style.display = isAuthenticated ? 'block' : 'none';
            document.getElementById('apiKeyManagement').style.display = isAuthenticated ? 'block' : 'none';
            document.getElementById('apiKeyTest').style.display = isAuthenticated ? 'block' : 'none';

            if (isAuthenticated) {
                const user = await auth0Client.getUser();
                const token = await auth0Client.getIdTokenClaims();
                const accessToken = await auth0Client.getTokenSilently();

                document.getElementById('userInfoContent').textContent = JSON.stringify(user, null, 2);
                document.getElementById('tokenInfoContent').textContent = JSON.stringify(token, null, 2);
                document.getElementById('accessTokenContent').textContent = accessToken;

                // Call /user_info endpoint to ensure database is updated
                await callApi('/user_info');

                const roles = user['https://watchhousesspm.com/roles'] || [];
                document.getElementById('apiKeyManagement').style.display = roles.includes('Admin') ? 'block' : 'none';
            }
        } finally {
            isUpdatingUI = false;
        }
    }

    async function login() {
        await auth0Client.loginWithRedirect({
            redirect_uri: window.location.origin
        });
    }

    async function logout() {
        await auth0Client.logout({
            logoutParams: {
                returnTo: window.location.origin
            }
        });
    }

    async function callApi(endpoint, retryCount = 0) {
        try {
            const token = await auth0Client.getTokenSilently();
            const response = await fetch(`${apiBaseUrl}${endpoint}`, {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            
            // Update user info if this was a call to /user_info
            if (endpoint === '/user_info') {
                const user = await auth0Client.getUser();
                Object.assign(user, data);
                document.getElementById('userInfoContent').textContent = JSON.stringify(user, null, 2);
            }
        } catch (error) {
            console.error('Error calling API:', error);
            if (error.error === 'login_required') {
                await auth0Client.loginWithRedirect();
            } else if (retryCount < 3) {
                console.log(`Retrying API call to ${endpoint}... (${retryCount + 1})`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                await callApi(endpoint, retryCount + 1);
            } else {
                document.getElementById('apiResponse').textContent = `Error: ${error.message}`;
                showError(`Failed to call API after multiple attempts: ${error.message}`);
            }
        }
    }

    async function createApiKey() {
        try {
            const token = await auth0Client.getTokenSilently();
            const user = await auth0Client.getUser();
            const orgId = user['https://watchhousesspm.com/org_id'];
            
            const response = await fetch(`${apiBaseUrl}/api-keys`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ org_id: orgId })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            alert(`New API Key created: ${data.api_key}`);
            listApiKeys();  // Refresh the list after creation
        } catch (error) {
            console.error('Error creating API key:', error);
            showError(`Failed to create API key: ${error.message}`);
        }
    }

    async function listApiKeys() {
        try {
            const token = await auth0Client.getTokenSilently();
            const response = await fetch(`${apiBaseUrl}/api-keys`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const apiKeyListElement = document.getElementById('apiKeyList');
            apiKeyListElement.innerHTML = '<h3>Your API Keys:</h3>';
            data.api_keys.forEach(key => {
                const keyElement = document.createElement('div');
                keyElement.innerHTML = `
                    ID: ${key.id}<br>
                    Key: ${key.key}<br>
                    Created: ${new Date(key.created_at).toLocaleString()}<br>
                    Last Used: ${key.last_used ? new Date(key.last_used).toLocaleString() : 'Never'}<br>
                    <button onclick="testApiKey('${key.key}')" class="btn btn-primary btn-sm">Test</button>
                    <button onclick="deleteApiKey('${key.id}')" class="btn btn-danger btn-sm">Delete</button>
                    <hr>
                `;
                apiKeyListElement.appendChild(keyElement);
            });
        } catch (error) {
            console.error('Error listing API keys:', error);
            showError(`Failed to list API keys: ${error.message}`);
        }
    }

    async function deleteApiKey(keyId) {
        try {
            const token = await auth0Client.getTokenSilently();
            const response = await fetch(`${apiBaseUrl}/api-keys/${keyId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            alert('API Key deleted successfully');
            listApiKeys();  // Refresh the list after deletion
        } catch (error) {
            console.error('Error deleting API key:', error);
            showError(`Failed to delete API key: ${error.message}`);
        }
    }

    async function testApiKey(apiKey) {
        try {
            const response = await fetch(`${apiBaseUrl}/api/org-data`, {
                headers: {
                    'X-API-Key': apiKey
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            alert(`API Key Test Successful!\nOrganization Data:\n${JSON.stringify(data, null, 2)}`);
        } catch (error) {
            console.error('Error testing API key:', error);
            showError(`Failed to test API key: ${error.message}`);
        }
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.textContent = message;
        document.querySelector('.container').appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    }
</script>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>